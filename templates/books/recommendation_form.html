{% extends 'base.html' %}

{% block title %}Подбор книги по настроению{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-magic me-2"></i> Подбор идеальной книги
                </h4>
            </div>
            <div class="card-body">
                <p class="lead text-muted mb-4">
                    Расскажите о своем текущем состоянии, и мы подберем книгу, которая идеально подойдет вам прямо сейчас.
                </p>
                
                <form method="post" id="recommendationForm">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="fas fa-battery-full me-2"></i> Уровень энергии
                                    </h5>
                                    <p class="card-text small text-muted">
                                        Как вы себя чувствуете физически?
                                    </p>
                                    
                                    <div class="btn-group-vertical w-100" role="group">
                                        {% for value, label in form.energy_level.field.choices %}
                                        <input type="radio" class="btn-check" name="energy_level" 
                                               id="energy_{{ value }}" value="{{ value }}" 
                                               {% if form.energy_level.value == value %}checked{% endif %}>
                                        <label class="btn btn-outline-primary mb-2 text-start" for="energy_{{ value }}">
                                            <i class="fas fa-{% if value == 'low' %}tired{% elif value == 'medium' %}battery-half{% else %}bolt{% endif %} me-2"></i>
                                            {{ label }}
                                        </label>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="fas fa-clock me-2"></i> Доступное время
                                    </h5>
                                    <p class="card-text small text-muted">
                                        Сколько времени у вас есть на чтение?
                                    </p>
                                    
                                    <div class="btn-group-vertical w-100" role="group">
                                        {% for value, label in form.time_available.field.choices %}
                                        <input type="radio" class="btn-check" name="time_available" 
                                               id="time_{{ value }}" value="{{ value }}"
                                               {% if form.time_available.value == value %}checked{% endif %}>
                                        <label class="btn btn-outline-primary mb-2 text-start" for="time_{{ value }}">
                                            <i class="fas fa-{% if value <= 30 %}hourglass-start{% elif value <= 60 %}hourglass-half{% else %}hourglass-end{% endif %} me-2"></i>
                                            {{ label }}
                                        </label>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="id_current_mood" class="form-label">
                            <i class="fas fa-smile me-2"></i> Опишите ваше текущее настроение
                        </label>
                        <textarea class="form-control" id="id_current_mood" name="current_mood" 
                                  rows="2" placeholder="Например: устал после работы, хочу отвлечься...">{{ form.current_mood.value|default:'' }}</textarea>
                        <div class="form-text">
                            Чем подробнее опишете, тем точнее подберем книгу
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="id_desired_mood_after" class="form-label">
                            <i class="fas fa-bullseye me-2"></i> Какого состояния хотите достичь после чтения?
                        </label>
                        <input type="text" class="form-control" id="id_desired_mood_after" 
                               name="desired_mood_after" value="{{ form.desired_mood_after.value|default:'' }}"
                               placeholder="Например: расслабиться, вдохновиться, сосредоточиться...">
                    </div>

                    <div class="mb-4">
                        <label class="form-label">
                            <i class="fas fa-tags me-2"></i> Выберите подходящие настроения:
                        </label>
                        <div class="row">
                            {% for tag in form.mood_tags.field.queryset %}
                            <div class="col-sm-6 col-md-4 col-lg-3 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           name="mood_tags" value="{{ tag.id }}" 
                                           id="tag_{{ tag.id }}">
                                    <label class="form-check-label" for="tag_{{ tag.id }}">
                                        <span class="badge bg-primary">
                                            {{ tag.emoji }} {{ tag.name }}
                                        </span>
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg px-5">
                            <i class="fas fa-search me-2"></i> Найти идеальную книгу
                        </button>
                    </div>
                </form>
            </div>
        </div>

        {% if stats %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i> Статистика системы
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <div class="stat-card p-3">
                            <h2 class="text-primary">{{ stats.total_books }}</h2>
                            <p class="mb-0 small">книг в базе</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="stat-card p-3">
                            <h2 class="text-primary">{{ stats.avg_pace|floatformat:1 }}</h2>
                            <p class="mb-0 small">средний темп чтения</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="stat-card p-3">
                            <h2 class="text-primary">{{ stats.avg_complexity|floatformat:1 }}</h2>
                            <p class="mb-0 small">средняя сложность</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="stat-card p-3">
                            <h2 class="text-primary">{% widthratio stats.click_rate 1 100 %}%</h2>
                            <p class="mb-0 small">успешных рекомендаций</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    $('.btn-check').on('change', function() {
        $(this).next('label').removeClass('btn-outline-primary').addClass('btn-primary');
        $(this).next('label').siblings('label').removeClass('btn-primary').addClass('btn-outline-primary');
    });

    $('.btn-check:checked').next('label').removeClass('btn-outline-primary').addClass('btn-primary');
});
</script>
{% endblock %}